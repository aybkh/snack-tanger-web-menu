// Translations
const translations = {
    es: {
        title: "Nuestra Carta",
        subtitle: "Snack Tanger 303",
        categories: {
            "Pizzas": "Pizzas",
            "Tacos 303": "Tacos",
            "Tajins": "Tajines",
            "Bocadillos Tanger": "Bocadillos",
            "Hamburguesas": "Hamburguesas",
            "Platos Combinados": "Platos Combinados",
            "Ensaladas": "Ensaladas",
            "Wraps": "Wraps",
            "Refrescos": "Refrescos",
            "Café": "Café",
            "Batidos": "Batidos",
            "Postres": "Postres",
            "Salsas y Suplementos": "Salsas y Suplementos"
        },
        ingredients: {},
        notes: {
            "MENÚ: Patatas + Bebida por +2€": "MENÚ: Patatas + Bebida por +2€",
            "Base: Leche o Agua. Zumo de Naranja (+0.50€)": "Base: Leche o Agua. Zumo de Naranja (+0.50€)"
        }
    },
    en: {
        title: "Our Menu",
        subtitle: "Snack Tanger 303",
        categories: {
            "Pizzas": "Pizzas",
            "Tacos 303": "Tacos",
            "Tajins": "Tajines",
            "Bocadillos Tanger": "Sandwiches",
            "Hamburguesas": "Burgers",
            "Platos Combinados": "Mixed Plates",
            "Ensaladas": "Salads",
            "Wraps": "Wraps",
            "Refrescos": "Soft Drinks",
            "Café": "Coffee",
            "Batidos": "Smoothies",
            "Postres": "Desserts",
            "Salsas y Suplementos": "Sauces & Extras"
        },
        ingredients: {
            "Pollo": "Chicken", "Carne Picada": "Minced Meat", "Ternera": "Beef",
            "Atún": "Tuna", "Gambas": "Shrimp", "Queso": "Cheese", "Verduras": "Vegetables",
            "Naranja": "Orange", "Fresa": "Strawberry", "Plátano": "Banana",
            "Café solo": "Espresso", "Café con leche": "Coffee with Milk",
            "Cordon Bleu": "Cordon Bleu", "Nuggets": "Nuggets",
            "Pinchos de": "Skewers of", "Salchichas": "Sausages", "Vegetal": "Vegetarian",
            "Carne": "Meat",
            "Hamburguesa": "Burger", "Plato de": "Plate of", "Plato": "Plate",
            "Ensalada": "Salad", "Wrap de": "Wrap", "Wrap": "Wrap",
            "S (1 Carne)": "S (1 Meat)", "M (1 Carne)": "M (1 Meat)",
            "L (2 Carnes)": "L (2 Meats)", "XL (3 Carnes)": "XL (3 Meats)",
            "Salsas": "Sauces", "Suplementos": "Extras", "Descafeinado": "Decaf",
            "Huevo": "Egg", "Arroz": "Rice", "Pan": "Bread", "Bacon": "Bacon",
            "Patatas": "Fries", "Incluye": "Includes", "Salsa": "Sauce"
        },
        notes: {
            "MENÚ: Patatas + Bebida por +2€": "MENU: Fries + Drink for +2€",
            "Base: Leche o Agua. Zumo de Naranja (+0.50€)": "Base: Milk or Water. Orange Juice (+0.50€)"
        }
    },
    fr: {
        title: "Notre Carte",
        subtitle: "Snack Tanger 303",
        categories: {
            "Pizzas": "Pizzas",
            "Tacos 303": "Tacos",
            "Tajins": "Tajines",
            "Bocadillos Tanger": "Sandwichs",
            "Hamburguesas": "Burgers",
            "Platos Combinados": "Plats Combinés",
            "Ensaladas": "Salades",
            "Wraps": "Wraps",
            "Refrescos": "Boissons",
            "Café": "Café",
            "Batidos": "Smoothies",
            "Postres": "Desserts",
            "Salsas y Suplementos": "Sauces et Suppléments"
        },
        ingredients: {
            "Pollo": "Poulet", "Carne Picada": "Viande Hachée", "Ternera": "Bœuf",
            "Atún": "Thon", "Gambas": "Crevettes", "Queso": "Fromage", "Verduras": "Légumes",
            "Naranja": "Orange", "Fresa": "Fraise", "Plátano": "Banane",
            "Café solo": "Espresso", "Café con leche": "Café au Lait",
            "Pinchos de": "Brochettes de", "Salchichas": "Saucisses", "Vegetal": "Végétarien",
            "Hamburguesa": "Burger", "Plato de": "Assiette de", "Plato": "Assiette",
            "Ensalada": "Salade", "Wrap de": "Wrap", "Wrap": "Wrap",
            "S (1 Carne)": "S (1 Viande)", "M (1 Carne)": "M (1 Viande)",
            "L (2 Carnes)": "L (2 Viandes)", "XL (3 Carnes)": "XL (3 Viandes)",
            "Salsas": "Sauces", "Suplementos": "Suppléments", "Descafeinado": "Décaféiné",
            "Carne": "Viande", "Cortado": "Noisette",
            "Huevo": "Oeuf", "Arroz": "Riz", "Pan": "Pain", "Bacon": "Bacon",
            "Patatas": "Frites", "Incluye": "Inclus", "Salsa": "Sauce"
        },
        notes: {
            "MENÚ: Patatas + Bebida por +2€": "MENU: Frites + Boisson pour +2€",
            "Base: Leche o Agua. Zumo de Naranja (+0.50€)": "Base: Lait ou Eau. Jus d'Orange (+0.50€)"
        }
    },
    de: {
        title: "Unsere Speisekarte",
        subtitle: "Snack Tanger 303",
        categories: {
            "Pizzas": "Pizzen",
            "Tacos 303": "Tacos",
            "Tajins": "Tajines",
            "Bocadillos Tanger": "Sandwiches",
            "Hamburguesas": "Burger",
            "Platos Combinados": "Gemischte Teller",
            "Ensaladas": "Salate",
            "Wraps": "Wraps",
            "Refrescos": "Erfrischungsgetränke",
            "Café": "Kaffee",
            "Batidos": "Smoothies",
            "Postres": "Desserts",
            "Salsas y Suplementos": "Soßen & Extras"
        },
        ingredients: {
            "Pollo": "Hähnchen", "Carne Picada": "Hackfleisch", "Ternera": "Rindfleisch",
            "Atún": "Thunfisch", "Gambas": "Garnelen", "Queso": "Käse", "Verduras": "Gemüse",
            "Naranja": "Orange", "Fresa": "Erdbeere", "Plátano": "Banane",
            "Café solo": "Schwarzer Kaffee", "Café con leche": "Milchkaffee",
            "Pinchos de": "Spieße von", "Salchichas": "Würstchen", "Vegetal": "Vegetarisch",
            "S (1 Carne)": "S (1 Fleisch)", "M (1 Carne)": "M (1 Fleisch)", "L (2 Carnes)": "L (2 Fleisch)", "XL (3 Carnes)": "XL (3 Fleisch)",
            "Hamburguesa": "Burger", "Plato de": "Teller mit", "Plato": "Teller",
            "Ensalada": "Salat", "Wrap de": "Wrap", "Wrap": "Wrap",
            "Salsas": "Soßen", "Suplementos": "Extras", "Descafeinado": "Koffeinfrei",
            "Huevo": "Ei", "Arroz": "Reis", "Pan": "Brot", "Bacon": "Speck",
            "Patatas": "Pommes", "Incluye": "Enthält", "Salsa": "Soße"
        },
        notes: {
            "MENÚ: Patatas + Bebida por +2€": "MENÜ: Pommes + Getränk für +2€",
            "Base: Leche o Agua. Zumo de Naranja (+0.50€)": "Basis: Milch oder Wasser. Orangensaft (+0,50€)"
        }
    },
    nl: {
        title: "Ons Menu",
        subtitle: "Snack Tanger 303",
        categories: {
            "Pizzas": "Pizza's",
            "Tacos 303": "Tacos",
            "Tajins": "Tajines",
            "Bocadillos Tanger": "Broodjes",
            "Hamburguesas": "Burgers",
            "Platos Combinados": "Gemengde Schotels",
            "Ensaladas": "Salades",
            "Wraps": "Wraps",
            "Refrescos": "Frisdranken",
            "Café": "Koffie",
            "Batidos": "Smoothies",
            "Postres": "Desserts",
            "Salsas y Suplementos": "Sauzen & Extra's"
        },
        ingredients: {
            "Pollo": "Kip", "Carne Picada": "Gehakt", "Ternera": "Rundvlees",
            "Atún": "Tonijn", "Gambas": "Garnalen", "Queso": "Kaas", "Verduras": "Groenten",
            "Naranja": "Sinaasappel", "Fresa": "Aardbei", "Plátano": "Banaan",
            "Café solo": "Zwarte Koffie", "Café con leche": "Koffie verkeerd",
            "Pinchos de": "Spiesjes van", "Salchichas": "Worstjes", "Vegetal": "Vegetarisch",
            "S (1 Carne)": "S (1 Vlees)", "M (1 Carne)": "M (1 Vlees)", "L (2 Carnes)": "L (2 Vlees)", "XL (3 Carnes)": "XL (3 Vlees)",
            "Hamburguesa": "Burger", "Plato de": "Schotel van", "Plato": "Schotel",
            "Ensalada": "Salade", "Wrap de": "Wrap", "Wrap": "Wrap",
            "Salsas": "Sauzen", "Suplementos": "Extra's", "Descafeinado": "Cafeïnevrij",
            "Huevo": "Ei", "Arroz": "Rijst", "Pan": "Brood", "Bacon": "Bacon",
            "Patatas": "Friet", "Incluye": "Inclusief", "Salsa": "Saus"
        },
        notes: {
            "MENÚ: Patatas + Bebida por +2€": "MENU: Friet + Drankje voor +2€",
            "Base: Leche o Agua. Zumo de Naranja (+0.50€)": "Basis: Melk of Water. Sinaasappelsap (+0.50€)"
        }
    },
    ar: {
        title: "قائمتنا",
        subtitle: "سناك طنجة 303",
        categories: {
            "Pizzas": "بيتزا",
            "Tacos 303": "طاكوس",
            "Tajins": "طاجين",
            "Bocadillos Tanger": "سندويشات",
            "Hamburguesas": "هامبرغر",
            "Platos Combinados": "أطباق متنوعة",
            "Ensaladas": "سلطات",
            "Wraps": "لفائف",
            "Refrescos": "مشروبات غازية",
            "Café": "قهوة",
            "Batidos": "عصائر",
            "Postres": "حلويات",
            "Salsas y Suplementos": "صلصات وإضافات"
        },
        ingredients: {
            "Pollo": "دجاج", "Carne Picada": "لحم مفروم", "Ternera": "لحم بقر",
            "Atún": "تونة", "Gambas": "جمبري", "Queso": "جبن", "Verduras": "خضروات",
            "Naranja": "برتقال", "Fresa": "فراولة", "Plátano": "موز",
            "Café solo": "قهوة سوداء", "Café con leche": "قهوة بالحليب",
            "Pinchos de Pollo": "قطبان دجاج", "Pinchos Ternera": "قطبان لحم",
            "Hamburguesa": "برغر", "Plato de": "طبق", "Plato": "طبق",
            "Ensalada": "سلطة", "Wrap de": "سندويش", "Wrap": "سندويش",
            "Salchichas": "نقانق", "Vegetal": "نباتي", "Mixto (2 carnes)": "مشكل (لحمين)",
            "S (1 Carne)": "صغير (لحم 1)", "M (1 Carne)": "متوسط (لحم 1)",
            "L (2 Carnes)": "كبير (لحمين)", "XL (3 Carnes)": "إكس إل (3 لحوم)",
            "Salsas": "صلصات", "Suplementos": "إضافات", "Descafeinado": "بدون كافيين",
            "Cortado": "مهرس", "Carne": "لحم", "Pinchos de": "قطبان",
            "Huevo": "بيض", "Arroz": "أرز", "Pan": "خبز", "Bacon": "لحم مقدد",
            "Patatas": "بطاطس", "Incluye": "يشمل", "Salsa": "صلصة"
        },
        notes: {
            "MENÚ: Patatas + Bebida por +2€": "قائمة: بطاطس + مشروب بـ +2 يورو",
            "Base: Leche o Agua. Zumo de Naranja (+0.50€)": "الأساس: حليب أو ماء. عصير برتقال (+0.50 يورو)"
        }
    }
};

// State
let currentLang = 'es';
let menuData = [];
let activeCategory = null;

// DOM Elements
const menuContainer = document.getElementById('menu-container');
const catNav = document.getElementById('cat-nav');
const loadingEl = document.getElementById('loading');
const yearEl = document.getElementById('year');
const langBtns = document.querySelectorAll('.lang-btn');

// Init
document.addEventListener('DOMContentLoaded', () => {
    yearEl.textContent = new Date().getFullYear();
    loadMenu();

    // Language Events
    langBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            setLanguage(btn.dataset.lang);
        });
    });
});

function loadMenu() {
    // Load from global variable defined in data.js to avoid local file FETCH CORS issues
    if (window.paramMenu) {
        menuData = window.paramMenu;
        loadingEl.style.display = 'none';
        renderMenu();
        renderNav();

        if (menuData.length > 0) {
            setActiveCategory(menuData[0].id);
        }
    } else {
        // Fallback: try fetch (will fail on local file system)
        fetch('menu.json')
            .then(res => res.json())
            .then(data => {
                menuData = data;
                loadingEl.style.display = 'none';
                renderMenu();
                renderNav();
                if (menuData.length > 0) setActiveCategory(menuData[0].id);
            })
            .catch(err => {
                console.error(err);
                loadingEl.innerHTML = "Error loading menu.<br>⚠️ If opening locally, use data.js method.";
            });
    }
}

function setLanguage(lang) {
    currentLang = lang;

    // Update UI
    document.documentElement.lang = lang;
    document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('subtitle').textContent = translations[lang].subtitle;

    // Update active class on buttons
    langBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });

    // Re-render text
    renderNav();
    renderMenu();
}

function setActiveCategory(id) {
    activeCategory = id;
    renderNav(); // Update active pill

    const target = document.getElementById(`cat-${id}`);
    if (target) {
        // Scroll with offset
        const y = target.getBoundingClientRect().top + window.scrollY - 180;
        window.scrollTo({ top: y, behavior: 'smooth' });
    }
}

function getTranslatedName(originalName) {
    if (currentLang === 'es') return originalName;

    const map = translations[currentLang].ingredients || {};
    let translated = originalName;

    // Direct match
    if (map[originalName]) return map[originalName];

    // Partial replacement (e.g. "Taco Pollo" -> "Taco Chicken")
    Object.keys(map).forEach(key => {
        // Use split/join to replace all occurrences without regex issues
        translated = translated.split(key).join(map[key]);
    });

    return translated;
}

function renderNav() {
    catNav.innerHTML = '';
    const t = translations[currentLang].categories;

    menuData.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = `nav-btn ${activeCategory === cat.id ? 'active' : ''}`;
        btn.textContent = t[cat.name] || cat.name;
        btn.onclick = () => setActiveCategory(cat.id);
        catNav.appendChild(btn);
    });
}

function renderMenu() {
    menuContainer.innerHTML = '';
    const tCats = translations[currentLang].categories;

    menuData.forEach(cat => {
        const section = document.createElement('section');
        section.id = `cat-${cat.id}`;
        section.className = 'category-section';

        const title = document.createElement('h2');
        title.className = 'cat-title';
        title.textContent = tCats[cat.name] || cat.name;
        section.appendChild(title);

        // Category Note (e.g. Menu +2e)
        if (cat.notes) {
            const tNotes = translations[currentLang].notes || {};
            const translatedNote = tNotes[cat.notes] || cat.notes;

            const noteDiv = document.createElement('div');
            noteDiv.className = 'cat-note';
            noteDiv.innerHTML = `<i data-lucide="info" width="16" height="16"></i> ${translatedNote}`;
            section.appendChild(noteDiv);
        }

        const grid = document.createElement('div');
        grid.className = 'product-grid';

        cat.products.forEach(prod => {
            const card = document.createElement('div');
            card.className = 'product-card';

            // Image Path Logic
            const slug = prod.name.toLowerCase()
                .replace(/ /g, '-')
                .replace(/ñ/g, 'n')
                .replace(/[^a-z0-9-]/g, '');
            const imgSrc = `products/${slug}.jpg`;

            // Price Logic
            let priceDisplay = '';
            if (prod.variants && prod.variants.length > 0) {
                const minPrice = Math.min(...prod.variants.map(v => v.price));
                priceDisplay = `${minPrice.toFixed(2)}€`;
            } else {
                priceDisplay = `${(prod.price || prod.base_price || 0).toFixed(2)}€`;
            }

            // Description / Variants
            let descDisplay = prod.description || '';
            // Translate description if available
            if (descDisplay) {
                descDisplay = getTranslatedName(descDisplay);
            }

            let variantHtml = '';

            if (prod.variants && prod.variants.length > 0) {
                // Check if variants are sizes (S, M, L, XL) for special table layout
                const isSizeVariant = prod.variants.some(v => v.name.includes('S') || v.name.includes('M') || v.name.includes('L'));

                if (isSizeVariant) {
                    variantHtml = `<div class="variant-grid">
                        ${prod.variants.map(v => `
                            <div class="variant-item">
                                <span class="v-name">${getTranslatedName(v.name)}</span>
                                <span class="v-price">${v.price}€</span>
                            </div>
                        `).join('')}
                    </div>`;
                } else {
                    // Standard list for other variants
                    variantHtml = `<div class="variant-list">
                        ${prod.variants.map(v => `<span class="v-tag">${getTranslatedName(v.name)} <b>${v.price}€</b></span>`).join('')}
                    </div>`;
                }
            }

            if (descDisplay) descDisplay = `<div class="prod-desc-text">${descDisplay}</div>`;
            descDisplay += variantHtml;

            // HTML Construction
            card.innerHTML = `
                <div class="prod-img">
                    <img src="${imgSrc}" alt="${prod.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="prod-placeholder">
                        <i data-lucide="chef-hat" width="24" height="24"></i>
                    </div>
                </div>
                <div class="prod-info">
                    <div class="prod-header">
                        <h3 class="prod-name">${getTranslatedName(prod.name)}</h3>
                        <div class="prod-price">${priceDisplay}</div>
                    </div>
                    ${descDisplay ? `<div class="prod-desc">${descDisplay}</div>` : ''}
                </div>
            `;

            grid.appendChild(card);
        });

        section.appendChild(grid);
        menuContainer.appendChild(section);
    });

    // Refresh Icons
    if (window.lucide) lucide.createIcons();
}
